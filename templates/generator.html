{% extends "base.html" %}

{% set no_container = True %}

{% block content %}

    <div class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">YouTube -> Written Instructions</h1>
            <p class="hero-subtitle">Cut through the noise. Get right to the important details.</p>
            <div class="hero-search">
                <form id="generatorForm" action="{{ url_for('generator') }}" method="POST">
                    <input type="url" name="youtubeLink" id="youtubeLink" value="{{ request.args.get('youtubeLink', '') }}" placeholder="Paste YouTube URL here" class="hero-input" required>
                    <button type="submit" class="hero-btn">
                        <img src="{{ url_for('static', filename='images/search.svg') }}" alt="Submit" class="search-icon">
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading Spinner and Text Container -->
    <div id="loadingContainer" class="loading-container" style="text-align: center; margin-top: 20px;">
        <div id="loadingSpinner" class="loading-spinner" style="display: none;"></div>
        <div id="loadingText" class="loading-text" style="display: none;">Analyzing...</div>
    </div>

    <!-- Video Title and Thumbnail -->
    <div class="video-details" id="videoDetails" style="text-align: center; margin-top: 20px; {% if not video_title and not thumbnail_url %} display: none; {% endif %}">
        <div class="thumbnail-container" style="display: inline-block; max-width: 30%; margin: 0 auto; border: 2px solid #ccc; border-radius: 8px; padding: 5px;">
            <!-- Display the actual thumbnail if available, otherwise show placeholder -->
            <img class="video-thumbnail" id="videoThumbnail" src="{{ thumbnail_url if thumbnail_url else url_for('static', filename='images/default-video-thumbnail.png') }}" alt="Video Thumbnail" style="width: 100%; height: auto; border-radius: 8px;">
        </div>
        <div class="video-title" id="videoTitle" style="font-size: 1.5rem; margin-top: 10px;">
            {{ video_title if video_title else "" }}
        </div>
    </div>

    <div id="resultContainer" style="margin-top: 30px;">
        {% if summary %}
            <!-- Container for the generated summary with some styling -->
            <div class="summary-output-container" style="border: 1px solid #ccc; border-radius: 8px; padding: 20px; background-color: #f9f9f9;">
                <div class="tutorial-content">
                    {{ summary | safe }} <!-- Render the Markdown content as HTML -->
                </div>
                <!-- Button to download the summary as a PDF -->
                <form method="GET" action="/download/pdf">
                    <input type="hidden" name="youtubeLink" value="{{ request.args.get('youtubeLink', '') }}">
                    <button type="submit" class="btn btn-secondary mt-3">Download as PDF</button>
                </form>
            </div>
        {% endif %}

        {% if error %}
            <div class="alert alert-danger mt-3">
                <strong>Error:</strong> {{ error }}
            </div>
        {% endif %}
    </div>

    <!-- JavaScript to handle form submission, video metadata fetch, and loading spinner -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById('generatorForm');
            const youtubeLinkInput = document.getElementById('youtubeLink');
            const loadingText = document.getElementById('loadingText');
            const loadingContainer = document.getElementById('loadingContainer');
            const videoThumbnail = document.getElementById('videoThumbnail');
            const videoDetails = document.getElementById('videoDetails');

            // Function to show the loading spinner and analyzing text
            function showLoadingSpinner() {
                document.getElementById('loadingSpinner').style.display = 'block';
                loadingText.style.display = 'block'; // Ensure "Analyzing..." is displayed with spinner
                loadingContainer.style.display = 'block';
            }

            // Function to hide loading spinner and analyzing text
            function hideLoadingSpinner() {
                document.getElementById('loadingSpinner').style.display = 'none';
                loadingText.style.display = 'none'; // Hide "Analyzing..." with the spinner
            }

            // Function to display video metadata (including thumbnail)
            function displayVideoMetadata(videoTitle, thumbnailUrl) {
                document.getElementById('videoTitle').innerText = videoTitle;
                videoThumbnail.src = thumbnailUrl; // Replace placeholder with actual thumbnail
                videoDetails.style.display = 'block'; // Show the thumbnail container
            }

            // Fetch video metadata via AJAX before form submission
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const youtubeLink = youtubeLinkInput.value;

                // Show spinner and thumbnail container immediately
                showLoadingSpinner();
                videoDetails.style.display = 'block'; // Show thumbnail container after form submission

                // Send AJAX request to fetch metadata
                fetch('/fetch_metadata', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ youtubeLink: youtubeLink })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.video_title && data.thumbnail_url) {
                        displayVideoMetadata(data.video_title, data.thumbnail_url);
                    }

                    // Submit the form after fetching metadata (continue generating summary)
                    form.submit();
                })
                .catch(error => {
                    console.error('Error fetching video metadata:', error);
                    // Submit the form anyway, even if metadata fetch fails
                    form.submit();
                });
            });

            // Hide the spinner and analyzing text once the summary is generated
            const summaryExists = {{ summary is not none and summary|length > 0 }};
            if (summaryExists) {
                hideLoadingSpinner();
            }

            // New: Auto-submit the form if a YouTube link is present in the input field
            const youtubeLink = youtubeLinkInput.value;
            if (youtubeLink) {
                form.submit();
            }
        });
    </script>

{% endblock %}
