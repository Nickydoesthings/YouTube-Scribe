{% extends "base.html" %}

{% block content %}
    <h1>YouTube Scribe</h1>
    <p>Enter a YouTube video URL to generate a written tutorial summary:</p>

    <form id="generatorForm" action="/" method="POST" style="margin-top: 20px;">
        <!-- Form for submitting YouTube link -->
        <div class="form-group">
            <label for="youtubeLink">YouTube Video URL:</label>
            <!-- Input field for the YouTube URL -->
            <input type="url" class="form-control" id="youtubeLink" name="youtubeLink" placeholder="https://www.youtube.com/watch?v=example" required>
        </div>
        <!-- Submit button -->
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>

    <!-- Loading Spinner (hidden by default) -->
    <div id="loadingSpinner" class="loading-spinner" style="display:none;"></div>
    <div id="loadingText" class="loading-text" style="display:none;">Analyzing...</div>

    <div id="resultContainer">
        {% if summary %}
            <!-- If a summary is generated, display it here -->
            <div class="summary-output">
                <h2>Generated Tutorial Summary:</h2>
                <div class="tutorial-content">
                    {{ summary | safe }}  <!-- Render the Markdown content as HTML -->
                </div>
                <!-- Button to download the summary as a PDF -->
                <form method="GET" action="/download/pdf">
                    <input type="hidden" name="summary" value="{{ summary | safe }}">
                    <button type="submit" class="btn btn-secondary mt-3">Download as PDF</button>
                </form>
            </div>
        {% endif %}

        {% if error %}
            <!-- If there's an error, display it here -->
            <div class="alert alert-danger mt-3">
                <strong>Error:</strong> {{ error }}
            </div>
        {% endif %}
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById('generatorForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the form from submitting the traditional way
            
            // Show the spinner and the "Analyzing..." text when the form is submitted
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('loadingText').style.display = 'block';

            // Collect the form data
            const formData = new FormData(this);

            // Perform the AJAX request
            fetch('/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(data => {
                // Hide the spinner and loading text
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('loadingText').style.display = 'none';

                // Update only the summary section
                const parser = new DOMParser();
                const doc = parser.parseFromString(data, 'text/html');
                const newSummary = doc.querySelector('.summary-output');
                const resultContainer = document.getElementById('resultContainer');

                // Clear the previous content
                resultContainer.innerHTML = '';

                // Append the new summary content
                if (newSummary) {
                    resultContainer.appendChild(newSummary);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('loadingText').style.display = 'none';
                document.getElementById('resultContainer').innerHTML = '<div class="alert alert-danger mt-3"><strong>Error:</strong> Something went wrong. Please try again later.</div>';
            });
        });
    });
    </script>

{% endblock %}
