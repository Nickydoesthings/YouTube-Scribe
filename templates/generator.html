{% extends "base.html" %}

{% set no_container = True %}

{% block content %}

    <div class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">YouTube -> Written Instructions</h1>
            <p class="hero-subtitle">Cut through the noise. Get to the point.</p>
            <div class="hero-search">
                <form id="generatorForm" action="{{ url_for('generator') }}" method="POST">
                    <!-- Include the CSRF token correctly -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="url" name="youtubeLink" id="youtubeLink" value="{{ youtube_link }}" placeholder="Paste YouTube URL here" class="hero-input" required>
                    <button type="submit" class="hero-btn">
                        <img src="{{ url_for('static', filename='images/search.svg') }}" alt="Submit" class="search-icon">
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading Spinner and Text Container -->
    <div id="loadingContainer" class="loading-container" style="text-align: center; margin-top: 20px;">
        <div id="loadingSpinner" class="loading-spinner" style="display: none;"></div>
        <div id="loadingText" class="loading-text" style="display: none;">Analyzing...</div>
    </div>

    <!-- Video Title and Thumbnail -->
    <div class="video-details" id="videoDetails" style="text-align: center; margin-top: 20px; {% if not video_title and not thumbnail_url %} display: none; {% endif %}">
        <div class="thumbnail-container" style="display: inline-block; max-width: 30%; margin: 0 auto; border: 2px solid #ccc; border-radius: 8px; padding: 5px;">
            <img class="video-thumbnail" id="videoThumbnail" src="{{ thumbnail_url if thumbnail_url else url_for('static', filename='images/default-video-thumbnail.png') }}" alt="Video Thumbnail" style="width: 100%; height: auto; border-radius: 8px;">
        </div>
        <div class="video-title" id="videoTitle" style="font-size: 1.5rem; margin-top: 10px;">
            {{ video_title if video_title else "" }}
        </div>
    </div>

    <div id="resultContainer" style="margin-top: 30px;">
    {% if summary %}
        <div class="summary-box">
            <div class="summary-output-container">
                <div class="tutorial-content">
                    {{ summary | safe }}
                </div>
                {% if current_user.is_authenticated and current_user.plan == 'pro' %}
                    <form method="POST" action="{{ url_for('download_pdf') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="summary" value="{{ summary | safe }}">
                        <button type="submit" class="btn btn-secondary mt-3">Download as PDF</button>
                    </form>
                {% else %}
                    <button id="downloadPdfButton" class="btn btn-secondary mt-3">Download as PDF</button>
                {% endif %}
            </div>
        </div>
    {% elif error %}
        <div class="alert alert-danger mt-3">
            <strong>Error:</strong> {{ error }}
        </div>
    {% endif %}
    </div>

    <!-- Upgrade Popup Modal -->
    <div class="modal fade" id="upgradeModal" tabindex="-1" aria-labelledby="upgradeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upgrade to Pro</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="hideUpgradeModal()">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="upgradeModalBody">
                    <!-- The message will be set dynamically -->
                </div>
                <div class="modal-footer">
                    <!-- Optionally remove this button if you include the link in the message -->
                    <!-- <a href="{{ url_for('pricing') }}" class="btn btn-primary">View Pricing</a> -->
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="hideUpgradeModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript to handle form submission, video metadata fetch, and loading spinner -->
    <script>
        // Define the pricing URL
        const pricingUrl = "{{ url_for('pricing') }}";

        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById('generatorForm');
            const youtubeLinkInput = document.getElementById('youtubeLink');
            const loadingText = document.getElementById('loadingText');
            const loadingContainer = document.getElementById('loadingContainer');
            const videoThumbnail = document.getElementById('videoThumbnail');
            const videoDetails = document.getElementById('videoDetails');

            // Retrieve CSRF token from the meta tag in base.html
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            function showLoadingSpinner() {
                document.getElementById('loadingSpinner').style.display = 'block';
                loadingText.style.display = 'block';
                loadingContainer.style.display = 'block';
            }

            function hideLoadingSpinner() {
                document.getElementById('loadingSpinner').style.display = 'none';
                loadingText.style.display = 'none';
            }

            function displayVideoMetadata(videoTitle, thumbnailUrl) {
                document.getElementById('videoTitle').innerText = videoTitle;
                videoThumbnail.src = thumbnailUrl;
                videoDetails.style.display = 'block';
            }

            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const youtubeLink = youtubeLinkInput.value;

                // Show the spinner while fetching metadata
                showLoadingSpinner();

                // Fetch video metadata via AJAX
                fetch('/fetch_metadata', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken  // Include CSRF token in the AJAX request header
                    },
                    body: JSON.stringify({ youtubeLink: youtubeLink })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.video_title && data.thumbnail_url) {
                        displayVideoMetadata(data.video_title, data.thumbnail_url);
                    }

                    // Submit the form after fetching metadata
                    form.submit();
                })
                .catch(error => {
                    console.error('Error fetching video metadata:', error);

                    // Submit the form anyway, even if metadata fetch fails
                    form.submit();
                });
            });

            function showUpgradeModal(upgradeReason, videoLength = null) {
                const upgradeModalBody = document.getElementById('upgradeModalBody');
                const upgradeModalFooter = document.querySelector('.modal-footer');
                
                let message = '';

                if (upgradeReason === 'download_pdf') {
                    message = 'Downloading summaries as PDF is a Pro feature.';
                } else if (upgradeReason === 'no_captions') {
                    message = 'Transcribing videos without captions is a Pro feature.';
                } else if (upgradeReason === 'video_duration') {
                    if (videoLength !== null) {
                        message = `Video Length: ${videoLength}. Processing videos longer than 15 minutes is a Pro feature.`;
                    } else {
                        message = 'Processing videos longer than 15 minutes is a Pro feature.';
                    }
                } else {
                    message = 'This feature is available for Pro users only.';
                }

                // Update the modal body with the message
                upgradeModalBody.innerHTML = message;

                // Add the "Upgrade to Pro" button in the modal footer, next to the "Close" button
                upgradeModalFooter.innerHTML = `
                    <a href="{{ url_for('pricing') }}" class="btn btn-primary">Upgrade to Pro</a>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="hideUpgradeModal()">Close</button>
                `;

                var modal = new bootstrap.Modal(document.getElementById('upgradeModal'));
                modal.show();
            }

            function hideUpgradeModal() {
                var modalElement = document.getElementById('upgradeModal');
                var modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }

            const summaryExists = {{ (summary is not none and summary|length > 0) | tojson }};
            if (summaryExists) {
                hideLoadingSpinner();
            }

            const showUpgradePopup = {{ show_upgrade_popup | tojson }};
            const upgradeReason = {{ upgrade_reason | tojson }};
            const videoLength = {{ video_length | tojson | default('null') }};

            if (showUpgradePopup) {
                showUpgradeModal(upgradeReason, videoLength);
            }

            const downloadPdfButton = document.getElementById('downloadPdfButton');
            if (downloadPdfButton) {
                downloadPdfButton.addEventListener('click', function() {
                    showUpgradeModal('download_pdf');
                });
            }
        });
    </script>

{% endblock %}
